
OFFICIAL VISIT MAPPING

   official_visit_id bigserial NOT NULL             --> GENERATED BY DPS
   prison_visit_slot_id bigint NOT NULL             --> Supplied - in migration request - from previously sent visit config data
   visit_date date NOT NULL                         --> Supplied - from NOMIS visit_date
   start_time time without time zone NOT NULL       --> Supplied - from NOMIS visit start_time
   end_time time without time zone NOT NULL         --> Supplied - from NOMIS end_time
   dps_location_id UUID NOT NULL                    --> Supplied - as mapped value for internal_location_id
   visit_status_code varchar(20) NOT NULL           --> Supplied - Syscon map to one of (SCHEDULED, CANCELLED, COMPLETED_NORMALLY, COMPLETED_ABNORMALLY, EXPIRED)
   visit_type_code varchar(20) NOT NULL             --> Supplied - DPS enum (IN_PERSON, VIDEO, TELEPHONE) - extra UNKNOWN from NOMIS? (ref: VIS_TYPE_CODE)
   prison_code varchar(10) NOT NULL                 --> Supplied - from NOMIS agy_loc_id
   prisoner_number varchar(7) NOT NULL              --> Supplied - obtained from OFFENDER_BOOK_ID
   current_term Boolean                             --> Supplied - true if this visit is against the booking_id of the current or latest term in prison
   staff_notes varchar(240)                         --> Only populated in DPS - private notes for staff
   prisoner_notes varchar(240)                      --> Supplied - from comment_text in NOMIS
   search_type_code varchar(20)                     --> Supplied - from NOMIS search_type (ref: SEARCH_TYPE)
   visitor_concern_text varchar(240)                --> Supplied - from NOMIS visitor_concern_text
   completion_code varchar(20)                      --> Supplied - supplied by Syscon (derived from EVENT_OUTCOME and OUTCOME_REASON_CODE)
   override_ban_by varchar(100)                     --> Supplied - Username from NOMIS lookup of override_ban_staff_id
   override_ban_time timestamp                      --> Supplied - otherwise null from NOMIS
   created_time timestamp NOT NULL                  --> Supplied - from NOMIS create_datetime
   created_by varchar(100) NOT NULL                 --> Supplied - from NOMIS lookup of create_user_id
   updated_time timestamp                           --> Supplied or null - Time of last modify from NOMIS modify_datetime
   updated_by varchar(100)                          --> Supplied or null - Username from NOMIS lookup of modify_user_id
   offender_visit_id bigint                         --> Supplied - set to NOMIS value of offender_visit_id, or null if created in DPS
   -- No DPS value --                               --> CLIENT_UNIQUE_REF - is this used?
   -- No DPS value --                               --> OFFENDER_VISIT_ORDER_ID - UR tells us no VOs for official visits? what if p


OFFICIAL VISITOR MAPPING

   official_visitor_id bigserial NOT NULL           --> GENERATED by DPS
   official_visit_id bigint NOT NULL                --> FK to visit
   visitor_type_code varchar(20) NOT NULL           --> Supplied - DPS enum (CONTACT, PRISONER, NOT_A_CONTACT, OPV) - migration defaults to CONTACT
   contact_type_code varchar(20) NOT NULL           --> Supplied - DPS enum (SOCIAL, OFFICIAL, NONE)
   contact_id bigint                                --> Supplied - person_id in NOMIS - should be present
   prisoner_contact_id bigint                       --> Not supplied - Migration service tries to establish - from name, person, and relationship? Set by DPS
   first_name varchar(60)                           --> Supplied - check against contacts?
   last_name varchar(60)                            --> Supplied - check against contacts?
   relationship_code varchar(20)                    --> Supplied - check against contacts?
   lead_visitor boolean NOT NULL                    --> Supplied - Group leader flag (Y/N) converted to Boolean
   assisted_visit boolean NOT NULL                  --> Supplied - Assisted visit flag (Y/N) converted to Boolean
   visitor_notes varchar(240)                       --> Supplied - From comment_text in NOMIS
   attendance_code varchar(20)                      --> Supplied - by Syscon - ATTENDED, or ABSENT - during migration or sync (derived from EVENT_OUTCOME and OUTCOME_REASON_CODE (ref: ATTENDANCE_CODE)
   attendance_by varchar(100)                       --> ??? DPS only - null on migration
   attendance_time timestamp                        --> ??? DPS only - null on migration
   created_time timestamp NOT NULL                  --> Supplied - Time of creation from NOMIS create_datetime
   created_by varchar(100) NOT NULL                 --> Supplied - Username from NOMIS lookup of create_user_id
   updated_time timestamp                           --> Supplied or null - Time of last modify from NOMIS modify_datetime
   updated_by varchar(100)                          --> Supplied of null - Username from NOMIS lookup of modify_user_id
   offender_visit_visitor_id bigint                 --> For migrated visits - set to the original ID in NOMIS

   QUESTIONS

   * Approval to visit is held against the relationship between an offender and a person, but an official visit does
     not contain a reference to the relationship, only to the person ID. Is this booking_id/person_id always a unique combination?

   * Could the same person id be in multiple relationships with a prisoner spanning multiple bookings?
     If so - we couldn't narrow it down to which relationship was related to which visit - we'd only know the person.
     This might be OK?

   * Will current_term=false allow us to see which person was the approved visitor for a previous booking? If there
     are multiple relationships between contact and prisoner we probably can't narrow it down? Should we just accept
     that we might need the offender_book_id for visits temporarily, whilst NOMIS is present in the sync?

   * Going forward, at the time a visit is booked, we CAN know the person and the relationship, and record this on
     the visit booking.

   * Are there any visit orders OFFENDER_VISIT_ORDER_ID specified on visits of type OFFICIAL in NOMIS? Yes. Do we
     need to store the VO number, even though we won't use it?

   * Is CLIENT_UNIQUE_REF ever populated for official visits?


   Coded values - OFFENDER_VISITS

   * VIS_STATUS        - ref domain VIS_STS   --> Map to DPS status SCHEDULED, CANCELLED, COMPLETED_NORMALLY, COMPLETED_ABNORMALLY, EXPIRED?

                         Value in the last 12 months:
                         NORM,411703    -> COMPLETED
                         SCH,316657     -> ACTIVE
                         VDE,336        -> ??
                         OFFEND,1100    -> CANCELLED + reason?
                         CANC,157382    -> CANCELLED + reason?
                         VISITOR,1914   -> CANCELLED + reason?
                         HMPOP,327      -> CANCELLED + reason?

   * SEARCH_TYPE         - ref domain SEARCH_TYPE    -->  Similar DPS reference list?

                         values in last 12 months:
                         FULL,29835       -> Ref data DPS?
                         RUB_A,222372
                         RUB_B,184999

   * VIS_COMPLETION  - Calculated by Syscon at time of migration or sync to NOMIS, from DPS values.
                     - One of
                         - NORMAL
                         - STAFF_CANCELLED
                         - VISITOR_CANCELLED
                         - PRISONER_REFUSED
                         - VISITOR_DENIED
                         - PRISONER_EARLY
                         - VISITOR_EARLY
                      - Calculated from EVENT_OUTCOME, EVENT_STS, OUTCOME_REASON_CODE

   * ATTENDANCE      - One of ATTENDED or ABSENT for each visitor, and the prisoner.

   Restrictions

    * VISIT_RESTRICTION_TYPE - NOMIS codes VST_RST_TYPE  --> We get from personal relationships..


There are three fields at visit level
   - Cancel Reason
   - Completion
   - Attended

These get saved into
   - OFFENDER_VISITS.VISIT_STATUS
   - OFFENDER_VISIT_VISITORS.EVENT_STATUS
   - OFFENDER_VISIT_VISITORS.OUTCOME_REASON_CODE
but can't work out what happens to Attended?

I can also see that OFFENDER_VISIT_VISITORS.EVENT_STATUS seems to get updated automatically by a process once the visit time is passed so
that the status becomes EXP, but the same doesn't happen to OFFENDER_VISITS.VISIT_STATUS.

Also the Attended field on the visitor gets saved to OFFENDER_VISITS.EVENT_OUTCOME, but I don't understand why there are 3 million null values
in the table when it looks like there is just a checkbox in the front end?

Thanks, that explains why there are null entries in the OFFENDER_VISITS.EVENT_OUTCOME table - since the null values are for the dummy row
(where the OFFENDER_BOOK_ID is not null) when the data is initially created.  So Attended at visit level gets written to the dummy row in
the OFFENDER_VISIT_VISITORS table.

I've now found the view and triggers in bitbucket.  I'm struggling to find any automated process that updates the visit once the time has
passed to EXP, do you know where about that would be?

Paul Morris
Its a batch job, FLUSH_SCHEDULES,  the procedure it runs is  tag_schedules.flush_schedules.